<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EASY HIIT TIMER</title>
    <link rel="icon" href="https://avatars.githubusercontent.com/u/86871974?v=4" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-grad: linear-gradient(135deg, #2b1055, #7597de);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --cyan: #00fff2; --red: #ff4d4d; --yellow: #ffd700;
        }
        * { box-sizing: border-box; transition: all 0.3s ease; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Kanit', sans-serif; background: var(--bg-grad); color: #fff; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; }
        
        /* Layout Handling via State Classes */
        body.view-workout #setup-screen { display: none; }
        body.view-workout #workout-screen { display: flex; }
        
        /* Party Mode Animation */
        @keyframes flow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .party-mode { background: linear-gradient(-45deg, #ff0000, #990000, #ff3333, #cc0000); background-size: 400% 400%; animation: flow 10s ease infinite; }

        /* UI Components */
        .neu-panel { background: var(--glass-bg); border-radius: 30px; border: 1px solid var(--glass-border); backdrop-filter: blur(10px); padding: 40px 30px; width: 90%; max-width: 500px; text-align: center; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
        .setting-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-size: 1.1rem; }
        .controls { display: flex; gap: 10px; }
        
        .neu-btn { width: 45px; height: 45px; border-radius: 50%; border: 1px solid var(--glass-border); background: var(--glass-bg); color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .neu-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.2); }
        
        .neu-input { width: 60px; height: 45px; border: 1px solid var(--glass-border); background: var(--glass-bg); color: var(--cyan); text-align: center; border-radius: 15px; font-size: 1.3rem; font-weight: 600; font-family: inherit; }
        .neu-input:focus { outline: none; background: rgba(255,255,255,0.2); }
        input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        /* Main Button */
        .action-btn { width: 100%; padding: 20px; font-size: 1.5rem; font-weight: 600; border-radius: 20px; border: 1px solid var(--glass-border); background: var(--glass-bg); color: var(--cyan); margin-top: 15px; cursor: pointer; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
        
        /* Stop Button State */
        body.view-workout .action-btn { position: fixed; bottom: 50px; left: 50%; transform: translateX(-50%); width: 85%; max-width: 400px; background: rgba(255, 0, 0, 0.2); color: var(--red); z-index: 100; }

        /* Mute Button */
        .mute-btn-fixed { position: fixed; top: 20px; right: 20px; z-index: 200; }
        .mute-line { display: none; }
        .muted .mute-line { display: block; }
        .muted { color: var(--red); border-color: var(--red); }

        /* Workout Screen */
        #workout-screen { display: none; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; position: absolute; top: 0; }
        .round-pill { padding: 8px 25px; border-radius: 50px; background: var(--glass-bg); border: 1px solid var(--glass-border); margin-bottom: 20px; }
        .phase-badge { font-size: 4rem; font-weight: 700; text-transform: uppercase; text-shadow: 0 0 20px currentColor; }
        .timer-big { font-size: 25vw; font-weight: 600; line-height: 1; text-shadow: 0 0 30px rgba(255,255,255,0.8); }
        @media (min-width: 600px) { .timer-big { font-size: 10rem; } }
        
        .text-cyan { color: var(--cyan); } .text-red { color: var(--red); } .text-yellow { color: var(--yellow); }
        .footer-credit { margin-top: 25px; font-size: 0.8rem; color: #a0a0a0; }
        .footer-credit a { color: #fff; text-decoration: none; border-bottom: 1px dotted #fff; }
    </style>
</head>
<body>

    <button id="mute-btn" class="neu-btn mute-btn-fixed" onclick="toggleMute()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
            <line x1="23" y1="9" x2="17" y2="15" class="mute-line"></line>
            <line x1="17" y1="9" x2="23" y2="15" class="mute-line"></line>
        </svg>
    </button>

    <div id="setup-screen" class="neu-panel">
        <h1 style="margin: 0 0 10px;">EASY HIIT TIMER</h1>
        <div id="total-time-calc" style="color:#a0a0a0; margin-bottom: 25px;">รวมเวลา: --:--</div>

        <div id="settings-container"></div>

        <button id="main-btn" class="action-btn" onclick="toggleWorkout()">START</button>
        <div class="footer-credit">Created with ❤️ by <a href="https://www.instagram.com/mylilboo/" target="_blank">mylilboo</a></div>
    </div>

    <div id="workout-screen">
        <div id="round-display" class="round-pill"></div>
        <div id="phase-title" class="phase-badge text-cyan"></div>
        <div id="quote-display" style="height: 25px; font-style: italic; margin-bottom: 5px;"></div>
        <div id="timer-display" class="timer-big"></div>
    </div>

    <script>
        // --- State & Config ---
        let state = { work: 30, rest: 15, rounds: 6, speedLevel: 3 };
        let app = { timer: null, timeLeft: 0, currentRound: 1, isRunning: false, phase: 'stopped', muted: false, wakeLock: null, audioCtx: new (window.AudioContext || window.webkitAudioContext)() };
        const quotes = {
            work: ["โยกหัวหลุด!", "เอาให้ตาแตก!", "เร็วกว่านี้!", "ไฟลุกแล้ววว!"],
            rest: ["พักสายตาเถอะนะ", "หายใจเข้า...", "นิ่งๆ ไว้", "เตรียมระเบิดพลัง"],
            ready: ["เตรียมตัวแสบตา...", "พร้อมมั้ย?", "3.. 2.. 1.."]
        };

        // --- Render UI Settings (Dynamic Generation to reduce HTML bloat) ---
        const configMap = [
            { id: 'work', label: 'เวลาลุย (วิ)', step: 5, min: 5 },
            { id: 'rest', label: 'เวลาพัก (วิ)', step: 5, min: 0 },
            { id: 'rounds', label: 'จำนวนรอบ', step: 1, min: 1 },
            { id: 'speedLevel', label: 'ความเร็วเสียง', step: 1, min: 1, max: 5, readonly: true }
        ];

        const container = document.getElementById('settings-container');
        configMap.forEach(cfg => {
            container.innerHTML += `
            <div class="setting-row">
                <div>${cfg.label}</div>
                <div class="controls">
                    <button class="neu-btn" onclick="adjust('${cfg.id}', -${cfg.step})">-</button>
                    <input type="number" id="val-${cfg.id}" class="neu-input" value="${state[cfg.id]}" 
                           onchange="adjust('${cfg.id}', 0, this.value)" ${cfg.readonly ? 'readonly' : ''}>
                    <button class="neu-btn" onclick="adjust('${cfg.id}', ${cfg.step})">+</button>
                </div>
            </div>`;
        });
        updateTotalCalc();

        // --- Core Functions ---
        function adjust(key, delta, manualVal = null) {
            let val = manualVal !== null ? parseInt(manualVal) : state[key] + delta;
            // Bounds checking
            const conf = configMap.find(c => c.id === key);
            if (val < (conf.min || 1)) val = conf.min || 1;
            if (conf.max && val > conf.max) val = conf.max;
            
            state[key] = val;
            document.getElementById(`val-${key}`).value = val;
            updateTotalCalc();
        }

        function updateTotalCalc() {
            let total = (state.work + state.rest) * state.rounds;
            document.getElementById('total-time-calc').innerText = `รวมเวลา: ${Math.floor(total / 60)} นาที ${total % 60} วินาที`;
        }

        // --- Audio Logic ---
        function playBeep(freq = 440, type = 'square') {
            if (app.muted) return;
            if (app.audioCtx.state === 'suspended') app.audioCtx.resume();
            const osc = app.audioCtx.createOscillator();
            const gain = app.audioCtx.createGain();
            osc.connect(gain); gain.connect(app.audioCtx.destination);
            osc.frequency.value = freq; osc.type = type;
            gain.gain.setValueAtTime(0.5, app.audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, app.audioCtx.currentTime + 0.1);
            osc.start(); osc.stop(app.audioCtx.currentTime + 0.1);
        }

        let soundLoop;
        function setPartyMode(active) {
            const body = document.body;
            if (active) {
                body.classList.add('party-mode');
                clearInterval(soundLoop);
                let delay = 600 - (state.speedLevel * 100);
                soundLoop = setInterval(() => playBeep(880, 'sawtooth'), delay);
            } else {
                body.classList.remove('party-mode');
                clearInterval(soundLoop);
            }
        }

        // --- Main Workflow ---
        async function toggleWorkout() {
            if (app.isRunning) return stopWorkout();
            
            // Start
            app.isRunning = true;
            app.currentRound = 1;
            document.body.classList.add('view-workout'); // Switch View CSS
            document.getElementById('main-btn').innerText = "STOP";
            
            try { app.wakeLock = await navigator.wakeLock.request('screen'); } catch(e){}
            startPhase('ready');
        }

        function stopWorkout() {
            app.isRunning = false;
            clearInterval(app.timer);
            setPartyMode(false);
            if (app.wakeLock) app.wakeLock.release();
            
            document.body.classList.remove('view-workout'); // Switch View CSS
            document.getElementById('main-btn').innerText = "START";
        }

        function startPhase(phase) {
            app.phase = phase;
            clearInterval(app.timer);
            
            const els = {
                round: document.getElementById('round-display'),
                title: document.getElementById('phase-title'),
                quote: document.getElementById('quote-display'),
                timer: document.getElementById('timer-display')
            };

            els.round.innerText = `รอบที่ ${app.currentRound} / ${state.rounds}`;
            
            // Config Phase
            let duration, color, titleText, quoteList, party = false;
            if (phase === 'ready') {
                duration = 5; color = 'var(--yellow)'; titleText = 'เตรียมตัว'; quoteList = quotes.ready;
            } else if (phase === 'work') {
                duration = state.work; color = 'var(--cyan)'; titleText = 'ลุย!'; quoteList = quotes.work; party = true;
            } else { // rest
                duration = state.rest; color = 'var(--red)'; titleText = 'พัก'; quoteList = quotes.rest;
            }

            app.timeLeft = duration;
            els.title.innerText = titleText;
            els.title.className = `phase-badge`; // Reset class
            els.title.style.color = color;
            els.timer.style.color = color;
            els.quote.innerText = quoteList[Math.floor(Math.random() * quoteList.length)];
            
            setPartyMode(party);
            updateTimerDisplay();

            app.timer = setInterval(() => {
                app.timeLeft--;
                updateTimerDisplay();
                if (app.timeLeft < 0) nextPhase();
            }, 1000);
        }

        function nextPhase() {
            if (app.phase === 'ready') return startPhase('work');
            if (app.phase === 'work') {
                if (app.currentRound >= state.rounds && state.rest === 0) return stopWorkout();
                if (app.currentRound >= state.rounds) return stopWorkout(); // End after last work if you prefer
                return startPhase('rest');
            }
            if (app.phase === 'rest') {
                app.currentRound++;
                if (app.currentRound > state.rounds) return stopWorkout();
                return startPhase('work');
            }
        }

        function updateTimerDisplay() {
            document.getElementById('timer-display').innerText = app.timeLeft;
        }

        function toggleMute() {
            app.muted = !app.muted;
            document.getElementById('mute-btn').classList.toggle('muted', app.muted);
        }
        
        // Re-acquire wake lock if tab changed
        document.addEventListener('visibilitychange', async () => {
            if (app.isRunning && document.visibilityState === 'visible') {
                try { app.wakeLock = await navigator.wakeLock.request('screen'); } catch(e){}
            }
        });
    </script>
</body>
</html>
